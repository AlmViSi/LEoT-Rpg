<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lost Edge of Time - Character</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto&family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            background-color: #0A0A0A;
            color: #D9E4DD;
            overflow-x: hidden;
        }
        
        #particle-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        
        header {
            background: rgba(26, 38, 57, 0.8);
            padding: 1rem;
            text-align: center;
            border-bottom: 2px solid #00A3E0;
        }
        
        header h1 {
            margin: 0;
            font-family: 'Cinzel', serif;
            color: #D9E4DD;
        }
        
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        .tab-container {
            display: flex;
            justify-content: center;
            margin-bottom: 1rem;
            position: relative;
            z-index: 10;
        }
        
        .tab {
            padding: 0.5rem 1rem;
            background: #1A2639;
            color: #D9E4DD;
            border: 1px solid #00A3E0;
            cursor: pointer;
            font-family: 'Cinzel', serif;
            transition: all 0.3s ease;
        }
        
        .tab:first-child {
            border-radius: 5px 0 0 5px;
        }
        
        .tab:last-child {
            border-radius: 0 5px 5px 0;
        }
        
        .tab.active {
            background: #00A3E0;
            color: #0A0A0A;
            font-weight: bold;
        }
        
        .tab:hover:not(.active) {
            background: rgba(0, 163, 224, 0.3);
        }
        
        .character-container {
            height: calc(100vh - 150px);
            padding: 1rem;
            overflow-y: auto;
            color: #D9E4DD;
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 1rem;
        }
        
        .character-portrait-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .character-portrait {
            width: 100%;
            height: 320px;
            background: #1A2639;
            border: 2px solid #00A3E0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            overflow: hidden;
        }
        
        .character-portrait img {
            max-width: 100%;
            max-height: 100%;
        }
        
        .character-portrait span {
            font-family: 'Cinzel', serif;
            color: #D9E4DD;
        }
        
        .character-info {
            margin-top: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .character-info input, 
        .character-info textarea {
            background: rgba(26, 38, 57, 0.8);
            border: 1px solid #00A3E0;
            color: #D9E4DD;
            padding: 0.5rem;
            border-radius: 5px;
            font-family: 'Roboto', sans-serif;
        }
        
        .character-info textarea {
            height: 80px;
            resize: vertical;
        }
        
        .character-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .character-action-btn {
            flex: 1;
            padding: 0.5rem;
            background: #00A3E0;
            color: #0A0A0A;
            border: none;
            border-radius: 5px;
            font-family: 'Cinzel', serif;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .character-action-btn:hover {
            background: #D9E4DD;
        }
        
        .uid-container {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .uid-input {
            flex: 1;
            background: rgba(26, 38, 57, 0.8);
            border: 1px solid #00A3E0;
            color: #D9E4DD;
            padding: 0.5rem;
            border-radius: 5px;
        }
        
        .load-uid-container {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .load-uid-input {
            flex: 1;
            background: rgba(26, 38, 57, 0.8);
            border: 1px solid #00A3E0;
            color: #D9E4DD;
            padding: 0.5rem;
            border-radius: 5px;
        }
        
        .points-left-container {
            background: rgba(26, 38, 57, 0.8);
            border: 1px solid #00A3E0;
            border-radius: 5px;
            padding: 0.5rem;
            text-align: center;
            font-family: 'Cinzel', serif;
            margin-top: auto;
        }
        
        .stats-column {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .main-stats {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.5rem;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(26, 38, 57, 0.8);
            padding: 0.5rem 1rem;
            border-radius: 5px;
            border: 1px solid #00A3E0;
        }
        
        .stat-controls {
            display: flex;
            align-items: center;
        }
        
        .stat-value {
            min-width: 30px;
            text-align: center;
            font-weight: bold;
            margin: 0 0.5rem;
        }
        
        .stat-btn {
            width: 25px;
            height: 25px;
            background: #00A3E0;
            border: none;
            color: #0A0A0A;
            font-weight: bold;
            cursor: pointer;
            border-radius: 3px;
        }
        
        .stat-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .derived-stats-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .derived-stats-column {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .derived-stat {
            background: rgba(26, 38, 57, 0.8);
            padding: 0.5rem;
            border: 1px solid #00A3E0;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
        }
        
        .derived-stat.special {
            background: rgba(40, 60, 90, 0.8);
        }
        
        .derived-stat div:first-child {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .derived-stat div:last-child {
            font-weight: bold;
            font-size: 1.1rem;
            text-align: right;
        }
        
        .sync-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            background: rgba(26, 38, 57, 0.8);
            padding: 0.5rem;
            border-radius: 5px;
            border: 1px solid #00A3E0;
        }
        
        .sync-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        
        .sync-label {
            font-family: 'Roboto', sans-serif;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .character-container {
                grid-template-columns: 1fr;
            }
            
            .derived-stats-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <canvas id="particle-canvas"></canvas>
    <header>
        <h1>Lost Edge of Time - Character</h1>
    </header>
    
    <div class="tab-container">
        <a href="index.html" class="tab">Origin</a>
        <a href="race.html" class="tab">Race</a>
        <a href="traits.html" class="tab">Traits</a>
        <a href="powersets.html" class="tab">Power Sets</a>
        <a href="character.html" class="tab active">Character</a>
    </div>
    
    <div class="main-container">
        <div class="character-container">
            <div class="character-portrait-container">
                <div class="character-portrait" id="character-portrait">
                    <span>Click to upload portrait</span>
                    <input type="file" id="portrait-upload" accept="image/*" style="display: none;">
                </div>
                
                <div class="character-info">
                    <input type="text" id="character-name" placeholder="Character Name">
                    <textarea id="character-bio" placeholder="Character Biography"></textarea>
                    
                    <div class="uid-container">
                        <input type="text" id="character-uid" class="uid-input" placeholder="Character UID" readonly>
                        <button class="character-action-btn" id="generate-uid-btn">Generate UID</button>
                    </div>
                    
                    <div class="load-uid-container">
                        <input type="text" id="load-uid-input" class="load-uid-input" placeholder="Enter UID to load">
                        <button class="character-action-btn" id="load-character-btn">Load</button>
                    </div>
                    
                    <div class="character-actions">
                        <button class="character-action-btn" id="save-character-btn">Save Character</button>
                        <button class="character-action-btn" id="clear-character-btn">Clear</button>
                    </div>
                    
                    <div class="sync-container">
                        <input type="checkbox" id="sync-checkbox" class="sync-checkbox">
                        <label for="sync-checkbox" class="sync-label">Синхронизация в реальном времени</label>
                    </div>
                </div>
            </div>
            
            <div class="stats-column">
                <div class="main-stats">
                    <div class="stat-item">
                        <span>Сила (STR):</span>
                        <div class="stat-controls">
                            <button class="stat-btn" data-stat="str" data-action="decrease">-</button>
                            <span class="stat-value" id="str-value">0</span>
                            <button class="stat-btn" data-stat="str" data-action="increase">+</button>
                        </div>
                    </div>
                    
                    <div class="stat-item">
                        <span>Выносливость (CON):</span>
                        <div class="stat-controls">
                            <button class="stat-btn" data-stat="con" data-action="decrease">-</button>
                            <span class="stat-value" id="con-value">0</span>
                            <button class="stat-btn" data-stat="con" data-action="increase">+</button>
                        </div>
                    </div>
                    
                    <div class="stat-item">
                        <span>Сноровка (DEX):</span>
                        <div class="stat-controls">
                            <button class="stat-btn" data-stat="dex" data-action="decrease">-</button>
                            <span class="stat-value" id="dex-value">0</span>
                            <button class="stat-btn" data-stat="dex" data-action="increase">+</button>
                        </div>
                    </div>
                    
                    <div class="stat-item">
                        <span>Ловкость (AGI):</span>
                        <div class="stat-controls">
                            <button class="stat-btn" data-stat="agi" data-action="decrease">-</button>
                            <span class="stat-value" id="agi-value">0</span>
                            <button class="stat-btn" data-stat="agi" data-action="increase">+</button>
                        </div>
                    </div>
                    
                    <div class="stat-item">
                        <span>Интеллект (INT):</span>
                        <div class="stat-controls">
                            <button class="stat-btn" data-stat="int" data-action="decrease">-</button>
                            <span class="stat-value" id="int-value">0</span>
                            <button class="stat-btn" data-stat="int" data-action="increase">+</button>
                        </div>
                    </div>
                    
                    <div class="stat-item">
                        <span>Мудрость (WIS):</span>
                        <div class="stat-controls">
                            <button class="stat-btn" data-stat="wis" data-action="decrease">-</button>
                            <span class="stat-value" id="wis-value">0</span>
                            <button class="stat-btn" data-stat="wis" data-action="increase">+</button>
                        </div>
                    </div>
                    
                    <div class="stat-item">
                        <span>Обаяние (CHA):</span>
                        <div class="stat-controls">
                            <button class="stat-btn" data-stat="cha" data-action="decrease">-</button>
                            <span class="stat-value" id="cha-value">0</span>
                            <button class="stat-btn" data-stat="cha" data-action="increase">+</button>
                        </div>
                    </div>
                </div>
                
                <div class="points-left-container">
                    Points left: <span id="points-left">36</span>
                </div>
                
                <div class="derived-stats-container">
                    <div class="derived-stats-column">
                        <div class="derived-stat">
                            <div>Запас Здоровья</div>
                            <div id="health-value">0</div>
                        </div>
                        
                        <div class="derived-stat">
                            <div>Запас Фокуса</div>
                            <div id="focus-value">0</div>
                        </div>
                        
                        <div class="derived-stat special">
                            <div>Колдовство</div>
                            <div id="witchcraft-value">0</div>
                        </div>
                        
                        <div class="derived-stat special">
                            <div>Мастерство</div>
                            <div id="mastery-value">0</div>
                        </div>
                        
                        <div class="derived-stat special">
                            <div>Могущество</div>
                            <div id="might-value">0</div>
                        </div>
                        
                        <div class="derived-stat">
                            <div>Концентрация</div>
                            <div id="concentration-value">0</div>
                        </div>
                        
                        <div class="derived-stat">
                            <div>Число Реакций</div>
                            <div id="reactions-value">0</div>
                        </div>
                    </div>
                    
                    <div class="derived-stats-column">
                        <div class="derived-stat">
                            <div>Грация</div>
                            <div id="grace-value">0</div>
                        </div>
                        
                        <div class="derived-stat">
                            <div>Предчувствие</div>
                            <div id="premonition-value">0</div>
                        </div>
                        
                        <div class="derived-stat special">
                            <div>Снижение Угрозы</div>
                            <div id="threat-value">0</div>
                        </div>
                        
                        <div class="derived-stat special">
                            <div>Влияние</div>
                            <div id="influence-value">0</div>
                        </div>
                        
                        <div class="derived-stat special">
                            <div>Харизма</div>
                            <div id="charisma-value">0</div>
                        </div>
                        
                        <div class="derived-stat">
                            <div>Число Умений</div>
                            <div id="skills-value">0</div>
                        </div>
                        
                        <div class="derived-stat">
                            <div>Число Черт</div>
                            <div id="traits-value">0</div>
                        </div>
                    </div>
                    
                    <div class="derived-stats-column">
                        <div class="derived-stat">
                            <div>Бдительность</div>
                            <div id="vigilance-value">0</div>
                        </div>
                        
                        <div class="derived-stat">
                            <div>Борьба</div>
                            <div id="combat-value">0</div>
                        </div>
                        
                        <div class="derived-stat">
                            <div>Логика</div>
                            <div id="logic-value">0</div>
                        </div>
                        
                        <div class="derived-stat">
                            <div>Самообладание</div>
                            <div id="composure-value">0</div>
                        </div>
                        
                        <div class="derived-stat">
                            <div>Сила Воли</div>
                            <div id="willpower-value">0</div>
                        </div>
                        
                        <div class="derived-stat">
                            <div>Стойкость</div>
                            <div id="resilience-value">0</div>
                        </div>
                        
                        <div class="derived-stat">
                            <div>Уклонение</div>
                            <div id="evasion-value">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Инициализация Firebase с правильным URL
        const firebaseConfig = {
            apiKey: "AIzaSyATqz2FEvuqJuFpeRNWs7MZ_G-jeEPk_dA",
            authDomain: "leot-rpg.firebaseapp.com",
            databaseURL: "https://leot-rpg-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "leot-rpg",
            storageBucket: "leot-rpg.appspot.com",
            messagingSenderId: "778831773412",
            appId: "1:778831773412:web:b27c883c463e41a25d36f1",
            measurementId: "G-P40D2VF1TQ"
        };
        
        // Инициализируем Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        document.addEventListener('DOMContentLoaded', () => {
            // DOM элементы
            const elements = {
                portraitUpload: document.getElementById('portrait-upload'),
                portraitContainer: document.getElementById('character-portrait'),
                characterName: document.getElementById('character-name'),
                characterBio: document.getElementById('character-bio'),
                characterUid: document.getElementById('character-uid'),
                loadUidInput: document.getElementById('load-uid-input'),
                pointsLeftElement: document.getElementById('points-left'),
                syncCheckbox: document.getElementById('sync-checkbox'),
                statValues: {
                    str: document.getElementById('str-value'),
                    con: document.getElementById('con-value'),
                    dex: document.getElementById('dex-value'),
                    agi: document.getElementById('agi-value'),
                    int: document.getElementById('int-value'),
                    wis: document.getElementById('wis-value'),
                    cha: document.getElementById('cha-value')
                },
                derivedStats: {
                    health: document.getElementById('health-value'),
                    focus: document.getElementById('focus-value'),
                    witchcraft: document.getElementById('witchcraft-value'),
                    mastery: document.getElementById('mastery-value'),
                    might: document.getElementById('might-value'),
                    concentration: document.getElementById('concentration-value'),
                    reactions: document.getElementById('reactions-value'),
                    grace: document.getElementById('grace-value'),
                    premonition: document.getElementById('premonition-value'),
                    threat: document.getElementById('threat-value'),
                    influence: document.getElementById('influence-value'),
                    charisma: document.getElementById('charisma-value'),
                    skills: document.getElementById('skills-value'),
                    traits: document.getElementById('traits-value'),
                    vigilance: document.getElementById('vigilance-value'),
                    combat: document.getElementById('combat-value'),
                    logic: document.getElementById('logic-value'),
                    composure: document.getElementById('composure-value'),
                    willpower: document.getElementById('willpower-value'),
                    resilience: document.getElementById('resilience-value'),
                    evasion: document.getElementById('evasion-value')
                }
            };
            
            // Состояние приложения
            const state = {
                pointsLeft: 36,
                stats: {
                    str: 0,
                    con: 0,
                    dex: 0,
                    agi: 0,
                    int: 0,
                    wis: 0,
                    cha: 0
                },
                portrait: null,
                isSyncing: false,
                syncRef: null
            };
            
            // Инициализация
            init();
            
            function init() {
                // Обработчики для кнопок характеристик
                document.querySelectorAll('.stat-btn').forEach(btn => {
                    btn.addEventListener('click', handleStatChange);
                });
                
                // Обработчики для основных кнопок
                document.getElementById('generate-uid-btn').addEventListener('click', generateUid);
                document.getElementById('save-character-btn').addEventListener('click', saveCharacter);
                document.getElementById('load-character-btn').addEventListener('click', loadCharacter);
                document.getElementById('clear-character-btn').addEventListener('click', clearCharacter);
                
                // Обработчик загрузки портрета
                elements.portraitContainer.addEventListener('click', () => elements.portraitUpload.click());
                elements.portraitUpload.addEventListener('change', handlePortraitUpload);
                
                // Обработчик синхронизации
                elements.syncCheckbox.addEventListener('change', toggleSync);
                
                // Обновляем отображение
                updateUI();
            }
            
            // Обработчик изменения характеристик
            function handleStatChange(e) {
                const stat = e.target.getAttribute('data-stat');
                const action = e.target.getAttribute('data-action');
                
                if (action === 'increase' && state.pointsLeft > 0 && state.stats[stat] < 10) {
                    state.stats[stat]++;
                    state.pointsLeft--;
                    updateUI();
                    if (state.isSyncing) {
                        saveCharacter(true); // Сохраняем без алерта
                    }
                } else if (action === 'decrease' && state.stats[stat] > 0) {
                    state.stats[stat]--;
                    state.pointsLeft++;
                    updateUI();
                    if (state.isSyncing) {
                        saveCharacter(true);
                    }
                }
            }
            
            // Обработчик загрузки портрета
            function handlePortraitUpload(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        elements.portraitContainer.innerHTML = `<img src="${event.target.result}" alt="Character Portrait">`;
                        state.portrait = event.target.result;
                        if (state.isSyncing) {
                            saveCharacter(true);
                        }
                    };
                    reader.readAsDataURL(file);
                }
            }
            
            // Генерация UID
            function generateUid() {
                const uid = 'xxxx-xxxx'.replace(/[x]/g, () => 
                    Math.floor(Math.random() * 16).toString(16)
                );
                elements.characterUid.value = uid;
                elements.loadUidInput.value = uid;
            }
            
            // Сохранение персонажа
            function saveCharacter(silent = false) {
                const uid = elements.characterUid.value;
                if (!uid) {
                    if (!silent) alert('Пожалуйста, сгенерируйте UID сначала');
                    return;
                }
                
                const characterData = {
                    name: elements.characterName.value,
                    bio: elements.characterBio.value,
                    stats: state.stats,
                    portrait: state.portrait,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };
                
                database.ref('characters/' + uid).set(characterData)
                    .then(() => {
                        if (!silent) alert('Персонаж сохранен с UID: ' + uid);
                    })
                    .catch((error) => {
                        console.error('Error saving character:', error);
                        if (!silent) alert('Ошибка сохранения: ' + error.message);
                    });
            }
            
            // Загрузка персонажа
            function loadCharacter() {
                const uid = elements.loadUidInput.value.trim();
                if (!uid) {
                    alert('Пожалуйста, введите UID для загрузки');
                    return;
                }
                
                // Отключаем синхронизацию перед загрузкой
                if (state.isSyncing) {
                    toggleSync(false);
                    elements.syncCheckbox.checked = false;
                }
                
                database.ref('characters/' + uid).once('value')
                    .then((snapshot) => {
                        const characterData = snapshot.val();
                        if (characterData) {
                            // Заполняем данные персонажа
                            elements.characterName.value = characterData.name || '';
                            elements.characterBio.value = characterData.bio || '';
                            elements.characterUid.value = uid;
                            
                            // Восстанавливаем характеристики
                            for (const stat in characterData.stats) {
                                state.stats[stat] = characterData.stats[stat];
                            }
                            state.pointsLeft = 36 - Object.values(state.stats).reduce((a, b) => a + b, 0);
                            
                            // Восстанавливаем портрет
                            if (characterData.portrait) {
                                elements.portraitContainer.innerHTML = `<img src="${characterData.portrait}" alt="Character Portrait">`;
                                state.portrait = characterData.portrait;
                            } else {
                                elements.portraitContainer.innerHTML = '<span>Click to upload portrait</span>';
                                state.portrait = null;
                            }
                            
                            updateUI();
                            alert('Персонаж успешно загружен!');
                        } else {
                            alert('Персонаж с таким UID не найден');
                        }
                    })
                    .catch((error) => {
                        console.error('Error loading character:', error);
                        alert('Ошибка загрузки: ' + error.message);
                    });
            }
            
            // Очистка формы
            function clearCharacter() {
                if (confirm('Вы уверены, что хотите очистить все данные персонажа?')) {
                    // Отключаем синхронизацию
                    if (state.isSyncing) {
                        toggleSync(false);
                        elements.syncCheckbox.checked = false;
                    }
                    
                    // Сбрасываем характеристики
                    state.stats = {
                        str: 0, con: 0, dex: 0, agi: 0, 
                        int: 0, wis: 0, cha: 0
                    };
                    state.pointsLeft = 36;
                    state.portrait = null;
                    
                    // Очищаем поля
                    elements.characterName.value = '';
                    elements.characterBio.value = '';
                    elements.characterUid.value = '';
                    elements.loadUidInput.value = '';
                    elements.portraitContainer.innerHTML = '<span>Click to upload portrait</span>';
                    elements.portraitUpload.value = '';
                    
                    updateUI();
                }
            }
            
            // Включение/выключение синхронизации
            function toggleSync(enable = null) {
                const shouldEnable = enable !== null ? enable : elements.syncCheckbox.checked;
                
                if (shouldEnable && !state.isSyncing) {
                    const uid = elements.characterUid.value;
                    if (!uid) {
                        alert('Пожалуйста, сгенерируйте или загрузите UID для синхронизации');
                        elements.syncCheckbox.checked = false;
                        return;
                    }
                    
                    // Включаем синхронизацию
                    state.isSyncing = true;
                    state.syncRef = database.ref('characters/' + uid);
                    
                    // Слушаем изменения в реальном времени
                    state.syncRef.on('value', (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            // Обновляем только если данные действительно изменились
                            if (JSON.stringify(data.stats) !== JSON.stringify(state.stats) ||
                                data.name !== elements.characterName.value ||
                                data.bio !== elements.characterBio.value ||
                                data.portrait !== state.portrait) {
                                
                                // Обновляем данные
                                elements.characterName.value = data.name || '';
                                elements.characterBio.value = data.bio || '';
                                
                                // Обновляем характеристики
                                for (const stat in data.stats) {
                                    state.stats[stat] = data.stats[stat];
                                }
                                state.pointsLeft = 36 - Object.values(state.stats).reduce((a, b) => a + b, 0);
                                
                                // Обновляем портрет
                                if (data.portrait && data.portrait !== state.portrait) {
                                    elements.portraitContainer.innerHTML = `<img src="${data.portrait}" alt="Character Portrait">`;
                                    state.portrait = data.portrait;
                                }
                                
                                updateUI();
                            }
                        }
                    });
                    
                    console.log('Синхронизация включена');
                } else if (!shouldEnable && state.isSyncing) {
                    // Выключаем синхронизацию
                    state.isSyncing = false;
                    if (state.syncRef) {
                        state.syncRef.off();
                        state.syncRef = null;
                    }
                    console.log('Синхронизация выключена');
                }
            }
            
            // Обновление интерфейса
            function updateUI() {
                // Обновляем значения характеристик
                for (const stat in state.stats) {
                    elements.statValues[stat].textContent = state.stats[stat];
                }
                
                // Обновляем оставшиеся очки
                elements.pointsLeft.textContent = state.pointsLeft;
                
                // Обновляем производные характеристики
                updateDerivedStats();
            }
            
            // Обновление производных характеристик
            function updateDerivedStats() {
                const str = state.stats.str;
                const con = state.stats.con;
                const dex = state.stats.dex;
                const agi = state.stats.agi;
                const int = state.stats.int;
                const wis = state.stats.wis;
                const cha = state.stats.cha;
                
                // Рассчитываем производные характеристики
                elements.derivedStats.health.textContent = (con + str) * 20;
                elements.derivedStats.focus.textContent = (dex + wis) * 20;
                elements.derivedStats.witchcraft.textContent = wis + cha;
                elements.derivedStats.mastery.textContent = agi + int;
                elements.derivedStats.might.textContent = str + dex;
                elements.derivedStats.concentration.textContent = Math.floor((con + wis) / 4);
                elements.derivedStats.reactions.textContent = Math.floor((con + agi) / 4);
                elements.derivedStats.grace.textContent = Math.floor((agi + cha) / 4);
                elements.derivedStats.premonition.textContent = Math.floor((dex + agi) / 4);
                elements.derivedStats.threat.textContent = Math.floor((str + int) / 2);
                elements.derivedStats.influence.textContent = Math.floor((str + wis) / 2);
                elements.derivedStats.charisma.textContent = Math.floor((con + cha) / 4);
                elements.derivedStats.skills.textContent = 4 + dex + int;
                elements.derivedStats.traits.textContent = Math.floor((cha + int) / 2);
                elements.derivedStats.vigilance.textContent = 10 + Math.floor((con + int) / 2);
                elements.derivedStats.combat.textContent = 10 + Math.floor((str + agi) / 2);
                elements.derivedStats.logic.textContent = 10 + Math.floor((int + wis) / 2);
                elements.derivedStats.composure.textContent = 10 + Math.floor((str + cha) / 2);
                elements.derivedStats.willpower.textContent = 10 + Math.floor((dex + cha) / 2);
                elements.derivedStats.resilience.textContent = 10 + Math.floor((con + dex) / 2);
                elements.derivedStats.evasion.textContent = 10 + Math.floor((agi + wis) / 2);
            }
            
            // Анимация частиц
            const canvas = document.getElementById('particle-canvas');
            const ctx = canvas.getContext('2d');
            let particles = [];

            function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            class Particle {
                constructor() {
                    this.x = Math.random() * canvas.width;
                    this.y = Math.random() * canvas.height;
                    this.size = Math.random() * 2 + 1;
                    this.speedX = Math.random() * 0.5 - 0.25;
                    this.speedY = Math.random() * 0.5 - 0.25;
                    this.opacity = Math.random() * 0.6 + 0.4;
                }

                update() {
                    this.x += this.speedX;
                    this.y += this.speedY;
                    if (this.x < 0 || this.x > canvas.width) this.speedX *= -1;
                    if (this.y < 0 || this.y > canvas.height) this.speedY *= -1;
                }

                draw() {
                    ctx.fillStyle = `rgba(0, 163, 224, ${this.opacity})`;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                    ctx.fill();
                }
            }

            function initParticles() {
                particles = [];
                for (let i = 0; i < 50; i++) {
                    particles.push(new Particle());
                }
            }

            function animateParticles() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                particles.forEach(p => {
                    p.update();
                    p.draw();
                });
                requestAnimationFrame(animateParticles);
            }

            initParticles();
            animateParticles();
        });
    </script>
</body>
</html>
